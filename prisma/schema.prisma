// This is your Prisma schema file
// learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// MODELOS PRINCIPALES
// =============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model User {
  id            String     @id @default(cuid())
  name          String
  lastName      String     @default("")
  email         String     @unique
  password      String?
  emailVerified DateTime?
  roles         UserRole[] @default([GUEST])
  status        UserStatus @default(ACTIVE)
  image         String?
  bio           String? // Datos del profesor integrados
  permissions   String[] // Permisos para administradores
  teamBadge     TeamBadge? // Badge del equipo para chat flotante
  accounts      Account[]
  teacherRankId String?

  // Relaciones comunes
  createdCourses     Course[]
  enrollments        Enrollment[]
  completedContents  UserContent[]
  viewedResources    ResourceView[]
  savedResources     UserResource[]
  activities         UserActivity[]
  attendances        ClassAttendance[]
  teacherAttendances TeacherAttendance[] @relation("TeacherAttendances")

  // Relaciones del sistema de clases
  bookingsAsStudent   ClassBooking[]        @relation("StudentBookings")
  bookingsAsTeacher   ClassBooking[]        @relation("TeacherBookings")
  classSchedules      ClassSchedule[]       @relation("TeacherSchedules")
  studentCredits      StudentCredit[]
  classCredits        ClassCredit[]
  teacherIncentives   TeacherIncentive[]
  teacherAvailability TeacherAvailability[]

  // Relación de profesor
  teacherRank TeacherRank? @relation(fields: [teacherRankId], references: [id])

  // Relación de racha de usuario
  userStreak UserStreak?

  // Relaciones del sistema de vidas y recompensas
  userLives          UserLives?
  userRewards        UserRewards?
  rewardTransactions RewardTransaction[]

  // Relaciones comerciales
  invoices             Invoice[]
  productPurchases     ProductPurchase[]
  scheduleSlotBookings ProductScheduleSlot[] @relation("ScheduleSlotBookings")
  subscriptions        Subscription[]

  // Relaciones de videollamadas JaaS
  teacherCalls VideoCall[] @relation("TeacherCalls")
  studentCalls VideoCall[] @relation("StudentCalls")

  // Relaciones de chat flotante
  conversationsAsParticipant ConversationParticipant[]
  sentFloatingMessages       FloatingChatMessage[]     @relation("SentFloatingMessages")

  // Relaciones de exámenes
  createdExams     Exam[]           @relation("ExamCreator")
  examAttempts     ExamAttempt[]    @relation("ExamAttempts")
  examAssignments  ExamAssignment[] @relation("ExamAssignments")
  assignedExams    ExamAssignment[] @relation("ExamAssigner")
  reviewedAnswers  ExamAnswer[]     @relation("ExamReviewer")

  // Relación de cursos que puede enseñar (para profesores)
  teachableCourses TeacherCourse[]

  // Relación de blog posts (para editores)
  blogPosts BlogPost[] @relation("BlogAuthor")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roles])
  @@index([teacherRankId])
}

model UserStreak {
  userId           String    @id
  currentStreak    Int       @default(0)
  longestStreak    Int       @default(0)
  lastActivityDate DateTime?
  updatedAt        DateTime  @updatedAt

  // Relación con User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_streaks")
}

model UserLives {
  userId           String   @id
  currentLives     Int      @default(5) // Máximo 5 vidas
  maxLives         Int      @default(5)
  lastRechargeTime DateTime @default(now())
  rechargeRate     Int      @default(30) // Minutos para recargar 1 vida
  updatedAt        DateTime @updatedAt

  // Relación con User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_lives")
}

model UserRewards {
  userId       String   @id
  totalPoints  Int      @default(0)
  spentPoints  Int      @default(0)
  currentLevel Int      @default(1)
  updatedAt    DateTime @updatedAt

  // Relación con User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_rewards")
}

model RewardTransaction {
  id          String     @id @default(cuid())
  userId      String
  type        RewardType
  amount      Int // Puntos ganados o gastados
  description String
  metadata    Json? // Información adicional sobre la transacción
  createdAt   DateTime   @default(now())

  // Relación con User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("reward_transactions")
}

// =============================================
// MODELOS DE CONTENIDO EDUCATIVO
// =============================================

model Course {
  id          String  @id @default(cuid())
  title       String
  description String
  language    String
  level       String
  isPublished Boolean @default(false)
  createdById String

  // Relaciones
  createdBy        User            @relation(fields: [createdById], references: [id])
  modules          Module[]
  enrollments      Enrollment[]
  products         Product[]
  plans            Plan[]
  exams            Exam[]
  teacherCourses   TeacherCourse[] // Profesores que pueden enseñar este curso

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
  @@map("courses")
}

model Module {
  id          String  @id @default(cuid())
  title       String
  description String?
  level       Int     @default(1)
  order       Int     @default(0)
  isPublished Boolean @default(false)
  courseId    String

  // Relaciones
  course     Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons    Lesson[]
  activities ModuleActivity[]
  exams      Exam[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([courseId])
  @@map("modules")
}

model Lesson {
  id          String @id @default(cuid())
  title       String
  description String
  order       Int    @default(0)
  moduleId    String

  // Relaciones
  module     Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  contents   Content[]
  activities LessonActivity[]
  exams      Exam[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([moduleId])
  @@map("lessons")
}

model Content {
  id          String      @id @default(cuid())
  title       String
  description String
  order       Int         @default(0)
  contentType ContentType
  lessonId    String

  // Relaciones
  lesson       Lesson        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  userProgress UserContent[]

  // Tipos específicos de contenido - relaciones 1:1
  grammarCard          GrammarCard?
  leveledText          LeveledText?
  thematicGlossary     ThematicGlossary?
  downloadableResource DownloadableResource?
  activity             Activity?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lessonId])
  @@map("contents")
}

model Activity {
  id           String       @id @default(cuid())
  contentId    String?      @unique // Opcional: puede existir independientemente
  title        String
  description  String
  activityType ActivityType
  level        Int          @default(1)
  points       Int          @default(10)
  duration     Int          @default(5) // en minutos
  activityData Json // Estructura de la actividad
  steps        Json // Pasos de la actividad con su estructura tipada
  questions    Json? // Preguntas, opciones y respuestas
  timeLimit    Int? // Tiempo límite en segundos
  createdById  String
  isPublished  Boolean      @default(false)

  // Relaciones
  content      Content?         @relation(fields: [contentId], references: [id])
  modules      ModuleActivity[]
  lessons      LessonActivity[]
  userProgress UserActivity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([contentId])
  @@map("activities")
}

// Tipos específicos de contenido

model GrammarCard {
  id            String  @id @default(cuid())
  contentId     String  @unique
  level         String
  grammarPoints Json // Puntos gramaticales con ejemplos
  explanations  Json // Explicaciones detalladas
  notes         String?

  // Relación
  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("grammar_cards")
}

model LeveledText {
  id          String  @id @default(cuid())
  contentId   String  @unique
  level       String
  textContent String // Texto completo
  translation String? // Traducción opcional
  audioUrl    String? // URL al archivo de audio
  vocabulary  Json? // Palabras destacadas
  exercises   Json? // Ejercicios de comprensión

  // Relación
  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("leveled_texts")
}

model ThematicGlossary {
  id         String @id @default(cuid())
  contentId  String @unique
  theme      String // Tema del glosario
  level      String
  terms      Json // Términos con definiciones
  categories Json? // Categorías para términos

  // Relación
  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("thematic_glossaries")
}

model DownloadableResource {
  id           String       @id @default(cuid())
  contentId    String       @unique
  resourceType ResourceType
  fileUrl      String // URL al archivo
  fileSize     Int // Tamaño en bytes
  fileFormat   String // PDF, DOCX, etc.
  previewUrl   String? // URL a vista previa
  pages        Int? // Número de páginas
  downloads    Int          @default(0)

  // Relaciones
  content   Content        @relation(fields: [contentId], references: [id], onDelete: Cascade)
  userSaves UserResource[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("downloadable_resources")
}

// =============================================
// MODELOS DE SEGUIMIENTO DE PROGRESO
// =============================================

model UserContent {
  id           String    @id @default(cuid())
  userId       String
  contentId    String
  completed    Boolean   @default(false)
  percentage   Float     @default(0)
  lastAccessed DateTime?

  // Relaciones
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  content Content @relation(fields: [contentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, contentId])
  @@index([userId])
  @@index([contentId])
  @@map("user_contents")
}

model UserActivity {
  userId        String
  activityId    String
  status        ActivityStatus @default(ASSIGNED)
  score         Float?
  answers       Json? // Respuestas dadas
  attempts      Int            @default(0)
  completedAt   DateTime?
  lastAttemptAt DateTime?
  assignedBy    String?
  assignedAt    DateTime       @default(now())

  // Relaciones
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@id([userId, activityId])
  @@index([userId])
  @@index([activityId])
  @@map("user_activities")
}

model ResourceView {
  id        String   @id @default(cuid())
  userId    String
  contentId String
  viewedAt  DateTime @default(now())

  // Relación
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([contentId])
  @@map("resource_views")
}

model UserResource {
  id         String   @id @default(cuid())
  userId     String
  resourceId String
  savedAt    DateTime @default(now())

  // Relaciones
  user     User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  resource DownloadableResource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  @@unique([userId, resourceId])
  @@index([userId])
  @@index([resourceId])
  @@map("user_resources")
}

model Enrollment {
  id               String           @id @default(cuid())
  studentId        String
  courseId         String
  academicPeriodId String
  status           EnrollmentStatus @default(ACTIVE)
  progress         Float            @default(0)
  enrollmentDate   DateTime         @default(now())
  lastAccessed     DateTime?
  classesTotal     Int              @default(8) // Total de clases en el paquete
  classesAttended  Int              @default(0) // Clases asistidas
  classesMissed    Int              @default(0) // Clases perdidas

  // Relaciones
  student        User              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course         Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  academicPeriod AcademicPeriod    @relation(fields: [academicPeriodId], references: [id], onDelete: Restrict)
  purchases      ProductPurchase[]
  bookings       ClassBooking[]    // Clases programadas para esta inscripción
  attendances    ClassAttendance[] // Asistencias para esta inscripción
  schedules      ClassSchedule[]   // Horarios recurrentes para esta inscripción

  @@unique([studentId, courseId, academicPeriodId])
  @@index([studentId])
  @@index([courseId])
  @@index([academicPeriodId])
  @@map("enrollments")
}

// =============================================
// MODELOS DE RELACIÓN (TABLAS PIVOTE)
// =============================================

model ModuleActivity {
  moduleId   String
  activityId String
  order      Int    @default(0)

  // Relaciones
  module   Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@id([moduleId, activityId])
  @@index([moduleId])
  @@index([activityId])
  @@map("module_activities")
}

model LessonActivity {
  lessonId   String
  activityId String
  order      Int    @default(0)

  // Relaciones
  lesson   Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  activity Activity @relation(fields: [activityId], references: [id], onDelete: Cascade)

  @@id([lessonId, activityId])
  @@index([lessonId])
  @@index([activityId])
  @@map("lesson_activities")
}

model TeacherCourse {
  teacherId String
  courseId  String

  // Relaciones
  teacher User   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@id([teacherId, courseId])
  @@index([teacherId])
  @@index([courseId])
  @@map("teacher_courses")
}

// =============================================
// MODELOS DE CLASES Y PERÍODOS ACADÉMICOS
// =============================================

model ClassBooking {
  id           String        @id @default(cuid())
  studentId    String
  teacherId    String
  enrollmentId String
  day          String // YYYY-MM-DD
  timeSlot     String // HH:MM-HH:MM
  status       BookingStatus @default(CONFIRMED)
  notes        String?
  reminderSent Boolean       @default(false)
  feedbackId   String?
  cancelledAt  DateTime?
  cancelledBy  String?
  completedAt  DateTime?
  creditId     String?

  // Relaciones
  student            User                @relation("StudentBookings", fields: [studentId], references: [id])
  teacher            User                @relation("TeacherBookings", fields: [teacherId], references: [id])
  enrollment         Enrollment          @relation(fields: [enrollmentId], references: [id])
  studentCredit      StudentCredit?      @relation(fields: [creditId], references: [id])
  attendances        ClassAttendance[]
  teacherAttendances TeacherAttendance[]
  videoCalls         VideoCall[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, day, timeSlot])
  @@index([studentId])
  @@index([teacherId])
  @@index([enrollmentId])
  @@map("class_bookings")
}

model Season {
  id          String   @id @default(cuid())
  name        String
  year        Int
  startDate   DateTime
  endDate     DateTime
  description String?

  // Relaciones
  periods AcademicPeriod[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, year])
  @@index([year])
  @@map("seasons")
}

model AcademicPeriod {
  id            String   @id @default(cuid())
  name          String
  startDate     DateTime
  endDate       DateTime
  seasonId      String
  isSpecialWeek Boolean  @default(false)
  isActive      Boolean  @default(false)

  // Relaciones
  season            Season             @relation(fields: [seasonId], references: [id])
  classCredits      ClassCredit[]
  teacherIncentives TeacherIncentive[]
  enrollments       Enrollment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seasonId])
  @@index([startDate, endDate])
  @@map("academic_periods")
}

model ClassSchedule {
  id           String @id @default(cuid())
  enrollmentId String
  teacherId    String
  dayOfWeek    Int // 0-6, 0 es domingo
  startTime    String // HH:MM
  endTime      String // HH:MM

  // Relaciones
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  teacher    User       @relation("TeacherSchedules", fields: [teacherId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([enrollmentId, dayOfWeek, startTime])
  @@index([teacherId, dayOfWeek])
  @@map("class_schedules")
}

model ClassCredit {
  id             String   @id @default(cuid())
  studentId      String
  originPeriodId String
  targetPeriodId String?
  creditAmount   Int      @default(1)
  isUsed         Boolean  @default(false)
  expiryDate     DateTime

  // Relaciones
  student      User           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  originPeriod AcademicPeriod @relation(fields: [originPeriodId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@index([originPeriodId])
  @@index([targetPeriodId])
  @@map("class_credits")
}

model StudentCredit {
  id         String   @id @default(cuid())
  studentId  String
  amount     Int      @default(1)
  source     String // rollover, perfect_attendance, etc.
  isUsed     Boolean  @default(false)
  usedFor    String? // class, discount, materials, etc.
  expiryDate DateTime

  // Relaciones
  student  User           @relation(fields: [studentId], references: [id])
  bookings ClassBooking[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@map("student_credits")
}

model TeacherIncentive {
  id          String    @id @default(cuid())
  teacherId   String
  periodId    String
  type        String // retention, perfect_attendance, etc.
  percentage  Float
  baseAmount  Float
  bonusAmount Float
  paid        Boolean   @default(false)
  paidAt      DateTime?

  // Relaciones
  teacher User           @relation(fields: [teacherId], references: [id])
  period  AcademicPeriod @relation(fields: [periodId], references: [id])

  createdAt DateTime @default(now())

  @@index([teacherId, periodId])
  @@map("teacher_incentives")
}

model TeacherRank {
  id                String @id @default(cuid())
  name              String // Basic, Certified, Senior, Master
  level             Int // 1, 2, 3, 4
  rateMultiplier    Float // 1.0, 1.05, 1.1, 1.15
  requirementHours  Int
  requirementRating Float
  requirementTime   Int // Meses mínimos en plataforma

  // Relaciones
  teachers User[]

  @@map("teacher_ranks")
}

model TeacherAvailability {
  id        String @id @default(cuid())
  userId    String
  day       String // Día semana o fecha específica YYYY-MM-DD
  startTime String // HH:MM
  endTime   String // HH:MM

  // Relación
  user User @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, day, startTime, endTime])
  @@index([userId, day])
  @@map("teacher_availability")
}

model ClassAttendance {
  id           String           @id @default(cuid())
  classId      String
  studentId    String
  enrollmentId String
  status       AttendanceStatus @default(PRESENT)
  timestamp    DateTime         @default(now())

  // Relations
  student    User         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  booking    ClassBooking @relation(fields: [classId], references: [id], onDelete: Cascade)
  enrollment Enrollment   @relation(fields: [enrollmentId], references: [id])

  // Indexes
  @@unique([classId, studentId])
  @@index([classId])
  @@index([studentId])
  @@index([enrollmentId])
  @@map("class_attendances")
}

model TeacherAttendance {
  id        String   @id @default(cuid())
  classId   String
  teacherId String
  status    String   @default("PRESENT")
  timestamp DateTime @default(now())

  // Relations
  teacher User         @relation("TeacherAttendances", fields: [teacherId], references: [id], onDelete: Cascade)
  booking ClassBooking @relation(fields: [classId], references: [id], onDelete: Cascade)

  // Indexes
  @@unique([classId, teacherId])
  @@index([classId])
  @@index([teacherId])
  @@map("teacher_attendances")
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

// =============================================
// MODELOS DE CONFIGURACIÓN Y SOPORTE
// =============================================

model CalendarSettings {
  id                      String @id @default(cuid())
  userId                  String @unique
  slotDuration            Int    @default(30)
  startHour               Float  @default(8)
  endHour                 Float  @default(16.5)
  maxBookingsPerStudent   Int    @default(3)
  bookingAdvanceNotice    Int    @default(24)
  cancellationWindow      Int    @default(12)
  rescheduleMinutes       Int    @default(60)
  maxReschedulesPerPeriod Int    @default(2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("calendar_settings")
}

// =============================================
// MODELOS DE TOKENS Y VERIFICACIÓN
// =============================================

model PasswordResetToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
  @@map("password_reset_tokens")
}

model VerificationToken {
  id      String   @id @default(cuid())
  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
  @@map("verification_tokens")
}

// =============================================
// MODELOS COMERCIALES
// =============================================

model Category {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  description String?
  image       String?
  isActive    Boolean @default(true)
  sortOrder   Int     @default(0)

  // Relaciones
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

model Feature {
  id          String  @id @default(cuid())
  name        String
  description String?
  icon        String?
  isActive    Boolean @default(true)

  // Relaciones
  planFeatures PlanFeature[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("features")
}

model Product {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  description  String?
  shortDesc    String?
  price        Float
  comparePrice Float?
  sku          String?  @unique
  image        String?
  images       String[]
  isActive     Boolean  @default(true)
  isDigital    Boolean  @default(true)
  stock        Int?
  categoryId   String?

  // Campos para programación y cursos
  requiresScheduling Boolean @default(false)
  courseId           String?
  maxScheduleSlots   Int?    @default(1) // Máximo de horarios que puede reservar
  scheduleDuration   Int?    @default(60) // Duración en minutos

  // Relaciones
  category      Category?             @relation(fields: [categoryId], references: [id])
  course        Course?               @relation(fields: [courseId], references: [id])
  plans         Plan[]
  invoiceItems  InvoiceItem[]
  scheduleSlots ProductScheduleSlot[]
  purchases     ProductPurchase[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([courseId])
  @@map("products")
}

model Plan {
  id           String  @id @default(cuid())
  name         String
  slug         String  @unique
  description  String?
  price        Float
  comparePrice Float?
  duration     Int // en días (duración del período de facturación)
  isActive     Boolean @default(true)
  isPopular    Boolean @default(false)
  sortOrder    Int     @default(0)
  productId    String?
  
  // Campos para planes con clases
  includesClasses     Boolean @default(false) // Si el plan incluye clases
  classesPerPeriod    Int?    // Cantidad de clases por período (ej: 8 clases por mes)
  classesPerWeek      Int?    // Frecuencia semanal (ej: 2 clases por semana)
  allowProration      Boolean @default(true) // Si permite prorateo al comprar a mitad de período
  autoRenewal         Boolean @default(true) // Si se renueva automáticamente
  billingCycle        String? // WEEKLY, MONTHLY, QUARTERLY, ANNUAL
  courseId            String? // Curso asociado al plan (opcional)

  // Relaciones
  product      Product?      @relation(fields: [productId], references: [id])
  course       Course?       @relation(fields: [courseId], references: [id])
  features     PlanFeature[]
  invoiceItems InvoiceItem[]
  subscriptions Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([courseId])
  @@map("plans")
}

model PlanFeature {
  planId    String
  featureId String
  included  Boolean @default(true)
  value     String? // Para características con valores específicos

  // Relaciones
  plan    Plan    @relation(fields: [planId], references: [id], onDelete: Cascade)
  feature Feature @relation(fields: [featureId], references: [id], onDelete: Cascade)

  @@id([planId, featureId])
  @@map("plan_features")
}

model Coupon {
  id          String     @id @default(cuid())
  code        String     @unique
  name        String?
  description String?
  type        CouponType @default(PERCENTAGE)
  value       Float // Porcentaje o cantidad fija
  minAmount   Float? // Monto mínimo para aplicar
  maxDiscount Float? // Descuento máximo (para porcentajes)
  usageLimit  Int? // Límite de usos total
  usageCount  Int        @default(0)
  userLimit   Int? // Límite por usuario
  isActive    Boolean    @default(true)
  startsAt    DateTime?
  expiresAt   DateTime?

  // Relaciones
  invoices Invoice[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("coupons")
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  userId        String
  subtotal      Float
  discount      Float         @default(0)
  tax           Float         @default(0)
  total         Float
  status        InvoiceStatus @default(DRAFT)
  currency      String        @default("USD")
  couponId      String?
  notes         String?
  dueDate       DateTime?
  paidAt        DateTime?

  // Relaciones
  user      User              @relation(fields: [userId], references: [id])
  coupon    Coupon?           @relation(fields: [couponId], references: [id])
  items     InvoiceItem[]
  purchases ProductPurchase[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([couponId])
  @@map("invoices")
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  productId String?
  planId    String?
  name      String // Nombre del producto/plan al momento de la compra
  price     Float
  quantity  Int     @default(1)
  total     Float

  // Relaciones
  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product Product? @relation(fields: [productId], references: [id])
  plan    Plan?    @relation(fields: [planId], references: [id])

  @@index([invoiceId])
  @@index([productId])
  @@index([planId])
  @@map("invoice_items")
}

// =============================================
// MODELOS DE BLOG
// =============================================

model BlogPost {
  id          String        @id @default(cuid())
  title       String
  slug        String        @unique
  excerpt     String?       // Resumen corto
  content     Json          // Contenido estructurado con componentes
  coverImage  String?       // URL de imagen destacada
  category    String?
  tags        String[]
  status      BlogStatus    @default(DRAFT)
  authorId    String
  readTime    Int?          // Tiempo estimado de lectura en minutos
  views       Int           @default(0)
  publishedAt DateTime?
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  // Relaciones
  author User @relation("BlogAuthor", fields: [authorId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([authorId])
  @@index([status])
  @@index([publishedAt])
  @@index([slug])
  @@map("blog_posts")
}

enum BlogStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// =============================================
// ENUMS
// =============================================

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  EDITOR
  GUEST
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum TeamBadge {
  SALES
  CUSTOMER_SERVICE
  ACADEMIC_COORDINATION
  TECHNICAL_SUPPORT
  ADMINISTRATION
  TEACHER
  STUDENT
}

enum ActivityStatus {
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  EXPIRED
}

enum ActivityType {
  LISTENING
  READING
  SPEAKING
  VOCABULARY
  WRITING
  GRAMMAR
  PRONUNCIATION
  COMPREHENSION
  MULTIPLE_CHOICE
  FILL_IN_BLANK
  MATCHING
  ORDERING
  DICTATION
  TRANSLATION
  OTHER
}

enum ActivityStepType {
  INSTRUCTION
  QUESTION
  AUDIO
  RECORDING
  COMPLETION
}

enum BookingStatus {
  CANCELLED
  COMPLETED
  CONFIRMED
  NO_SHOW
  PENDING
}

enum EnrollmentStatus {
  PENDING   // Pre-inscripción (período no ha iniciado)
  ACTIVE    // Inscripción activa (período en curso)
  COMPLETED // Curso completado
  PAUSED    // Pausado temporalmente
  CANCELLED // Cancelado
}

enum ContentType {
  GRAMMAR_CARD
  LEVELED_TEXT
  THEMATIC_GLOSSARY
  DOWNLOADABLE_RESOURCE
  ACTIVITY
  VIDEO
  PODCAST
  OTHER
}

enum ResourceType {
  GRAMMAR_GUIDE
  VOCABULARY_LIST
  EXERCISE_SHEET
  INFOGRAPHIC
  CONJUGATION_TABLE
  TEMPLATE
  OTHER
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
}

// =============================================
// MODELOS DE PROGRAMACIÓN Y RESERVAS
// =============================================

model ProductScheduleSlot {
  id        String   @id @default(cuid())
  productId String
  date      DateTime // Fecha y hora del slot
  isBooked  Boolean  @default(false)
  bookedBy  String? // ID del usuario que reservó

  // Relaciones
  product   Product           @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User?             @relation("ScheduleSlotBookings", fields: [bookedBy], references: [id])
  purchases ProductPurchase[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productId, date])
  @@index([productId])
  @@index([bookedBy])
  @@map("product_schedule_slots")
}

model ProductPurchase {
  id             String         @id @default(cuid())
  userId         String
  productId      String
  invoiceId      String
  scheduleSlotId String? // Slot reservado si aplica
  enrollmentId   String? // Inscripción creada automáticamente
  status         PurchaseStatus @default(PENDING)
  purchaseDate   DateTime       @default(now())
  scheduledDate  DateTime? // Fecha programada si aplica

  // Relaciones
  user         User                 @relation(fields: [userId], references: [id])
  product      Product              @relation(fields: [productId], references: [id])
  invoice      Invoice              @relation(fields: [invoiceId], references: [id])
  scheduleSlot ProductScheduleSlot? @relation(fields: [scheduleSlotId], references: [id])
  enrollment   Enrollment?          @relation(fields: [enrollmentId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([productId])
  @@index([invoiceId])
  @@map("product_purchases")
}

enum PurchaseStatus {
  PENDING
  CONFIRMED
  SCHEDULED
  ENROLLED
  COMPLETED
  CANCELLED
}

model Subscription {
  id                String             @id @default(cuid())
  userId            String
  planId            String
  status            SubscriptionStatus @default(ACTIVE)
  startDate         DateTime           @default(now())
  endDate           DateTime?
  nextBillingDate   DateTime?
  cancelledAt       DateTime?
  cancelReason      String?
  
  // Campos de prorateo
  proratedPrice     Float? // Precio prorrateado si se compró a mitad de período
  proratedClasses   Int?   // Clases prorrateadas
  remainingClasses  Int?   // Clases restantes en el período actual
  
  // Relaciones
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan              Plan               @relation(fields: [planId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([planId])
  @@index([status])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAUSED
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

enum RewardType {
  EARNED_ACTIVITY // Puntos ganados por completar actividad
  EARNED_STREAK // Puntos ganados por racha
  EARNED_LEVEL // Puntos ganados por subir de nivel
  SPENT_LIVES // Puntos gastados en vidas
  SPENT_PREMIUM // Puntos gastados en lecciones premium
  SPENT_MERCHANDISE // Puntos gastados en mercancía
  SPENT_COUPON // Puntos gastados en cupones
}

// =============================================
// MODELOS DE EXÁMENES
// =============================================

model Exam {
  id              String      @id @default(cuid())
  title           String
  description     String
  instructions    String?     // Instrucciones generales del examen
  timeLimit       Int?        // Tiempo límite total en minutos
  passingScore    Float       @default(70) // Puntaje mínimo para aprobar (%)
  maxAttempts     Int         @default(3) // Máximo número de intentos
  isBlocking      Boolean     @default(false) // Bloquea progreso si no se aprueba
  isOptional      Boolean     @default(false) // Es opcional para el curso
  isPublished     Boolean     @default(false)
  shuffleQuestions Boolean    @default(false) // Mezclar preguntas
  shuffleOptions  Boolean     @default(false) // Mezclar opciones
  showResults     Boolean     @default(true) // Mostrar resultados al finalizar
  allowReview     Boolean     @default(true) // Permitir revisar respuestas
  createdById     String

  // Relaciones de contexto (opcional - puede estar en curso, módulo o lección)
  courseId        String?
  moduleId        String?
  lessonId        String?

  // Relaciones
  creator         User            @relation("ExamCreator", fields: [createdById], references: [id])
  course          Course?         @relation(fields: [courseId], references: [id])
  module          Module?         @relation(fields: [moduleId], references: [id])
  lesson          Lesson?         @relation(fields: [lessonId], references: [id])
  sections        ExamSection[]
  attempts        ExamAttempt[]
  assignments     ExamAssignment[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([courseId])
  @@index([moduleId])
  @@index([lessonId])
  @@index([createdById])
  @@map("exams")
}

model ExamSection {
  id              String          @id @default(cuid())
  examId          String
  title           String
  description     String?
  instructions    String?         // Instrucciones específicas de la sección
  timeLimit       Int?            // Tiempo límite de la sección en minutos
  order           Int             @default(0)
  points          Float           @default(0) // Puntos totales de la sección

  // Relaciones
  exam            Exam            @relation(fields: [examId], references: [id], onDelete: Cascade)
  questions       ExamQuestion[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([examId])
  @@map("exam_sections")
}

model ExamQuestion {
  id              String          @id @default(cuid())
  sectionId       String
  type            QuestionType
  question        String          // Texto de la pregunta
  options         Json?           // Opciones para preguntas de opción múltiple
  correctAnswer   Json            // Respuesta(s) correcta(s)
  explanation     String?         // Explicación de la respuesta
  points          Float           @default(1) // Puntos que vale la pregunta
  order           Int             @default(0)
  difficulty      QuestionDifficulty @default(MEDIUM)
  tags            String[]        // Tags para categorización
  
  // Configuraciones específicas por tipo de pregunta
  caseSensitive   Boolean         @default(false) // Para preguntas de texto
  partialCredit   Boolean         @default(false) // Crédito parcial
  minLength       Int?            // Longitud mínima para ensayos
  maxLength       Int?            // Longitud máxima para ensayos

  // Configuraciones para ejercicios de listening
  audioUrl        String?         // URL del archivo de audio
  audioPosition   AudioPosition   @default(BEFORE_QUESTION) // Dónde mostrar el reproductor
  maxAudioPlays   Int?            // Número máximo de reproducciones (null = ilimitado)
  audioAutoplay   Boolean         @default(false) // Reproducir automáticamente
  audioPausable   Boolean         @default(false) // Permitir pausar el audio

  // Relaciones
  section         ExamSection     @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  answers         ExamAnswer[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([sectionId])
  @@map("exam_questions")
}

model ExamAttempt {
  id              String          @id @default(cuid())
  examId          String
  userId          String
  attemptNumber   Int             // Número del intento (1, 2, 3...)
  status          AttemptStatus   @default(IN_PROGRESS)
  score           Float?          // Puntaje obtenido (%)
  totalPoints     Float?          // Puntos totales obtenidos
  maxPoints       Float?          // Puntos máximos posibles
  timeSpent       Int?            // Tiempo gastado en minutos
  startedAt       DateTime        @default(now())
  submittedAt     DateTime?
  reviewedAt      DateTime?       // Cuando fue revisado (para preguntas manuales)
  
  // Configuración del intento
  questionsOrder  Json?           // Orden de las preguntas si fueron mezcladas
  optionsOrder    Json?           // Orden de las opciones si fueron mezcladas
  
  // Relaciones
  exam            Exam            @relation(fields: [examId], references: [id], onDelete: Cascade)
  user            User            @relation("ExamAttempts", fields: [userId], references: [id], onDelete: Cascade)
  answers         ExamAnswer[]

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([examId, userId, attemptNumber])
  @@index([examId])
  @@index([userId])
  @@map("exam_attempts")
}

model ExamAnswer {
  id              String          @id @default(cuid())
  attemptId       String
  questionId      String
  answer          Json            // Respuesta dada por el estudiante
  isCorrect       Boolean?        // Si es correcta (null para preguntas manuales)
  pointsEarned    Float           @default(0) // Puntos ganados
  timeSpent       Int?            // Tiempo gastado en esta pregunta (segundos)
  
  // Para revisión manual
  needsReview     Boolean         @default(false)
  reviewedBy      String?         // ID del profesor que revisó
  reviewedAt      DateTime?
  feedback        String?         // Comentarios del profesor

  // Relaciones
  attempt         ExamAttempt     @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question        ExamQuestion    @relation(fields: [questionId], references: [id], onDelete: Cascade)
  reviewer        User?           @relation("ExamReviewer", fields: [reviewedBy], references: [id])

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([attemptId, questionId])
  @@index([attemptId])
  @@index([questionId])
  @@map("exam_answers")
}

model ExamAssignment {
  id              String          @id @default(cuid())
  examId          String
  userId          String          // Estudiante asignado
  assignedBy      String          // Profesor que asignó
  dueDate         DateTime?       // Fecha límite
  instructions    String?         // Instrucciones específicas para este estudiante
  status          AssignmentStatus @default(ASSIGNED)
  
  // Relaciones
  exam            Exam            @relation(fields: [examId], references: [id], onDelete: Cascade)
  student         User            @relation("ExamAssignments", fields: [userId], references: [id], onDelete: Cascade)
  assignedByUser  User            @relation("ExamAssigner", fields: [assignedBy], references: [id])

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@unique([examId, userId])
  @@index([examId])
  @@index([userId])
  @@index([assignedBy])
  @@map("exam_assignments")
}

// =============================================
// MODELOS DE VIDEOLLAMADAS Y COMUNICACIÓN
// =============================================

model VideoCall {
  id           String     @id @default(cuid())
  roomId       String     @unique
  teacherId    String
  studentId    String
  bookingId    String?    @unique // Vinculado a ClassBooking existente
  status       CallStatus @default(SCHEDULED)
  startTime    DateTime
  endTime      DateTime?
  duration     Int? // en minutos
  recordingUrl String? // URL de grabación JaaS (24h storage)

  // Relaciones
  teacher User          @relation("TeacherCalls", fields: [teacherId], references: [id])
  student User          @relation("StudentCalls", fields: [studentId], references: [id])
  booking ClassBooking? @relation(fields: [bookingId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teacherId])
  @@index([studentId])
  @@index([bookingId])
  @@index([status])
  @@map("video_calls")
}

// Modelos para chat flotante
model FloatingConversation {
  id            String    @id @default(cuid())
  title         String?
  isGroup       Boolean   @default(false)
  lastMessage   String?
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relaciones
  participants ConversationParticipant[]
  messages     FloatingChatMessage[]

  @@map("floating_conversations")
}

model ConversationParticipant {
  id             String    @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime  @default(now())
  lastReadAt     DateTime?

  // Relaciones
  conversation FloatingConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@map("conversation_participants")
}

model FloatingChatMessage {
  id             String      @id @default(cuid())
  conversationId String
  senderId       String
  content        String
  type           MessageType @default(TEXT)
  timestamp      DateTime    @default(now())
  isRead         Boolean     @default(false)

  // Relaciones
  conversation FloatingConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User                 @relation("SentFloatingMessages", fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@index([timestamp])
  @@map("floating_chat_messages")
}

enum CallStatus {
  SCHEDULED
  ACTIVE
  ENDED
  CANCELLED
  FAILED
}

enum MessageType {
  TEXT
  FILE
  SYSTEM
  EMOJI
}

// =============================================
// ENUMS DE EXÁMENES
// =============================================

enum QuestionType {
  MULTIPLE_CHOICE    // Opción múltiple
  TRUE_FALSE        // Verdadero/Falso
  SHORT_ANSWER      // Respuesta corta
  ESSAY            // Ensayo
  FILL_BLANK       // Llenar espacios en blanco
  MATCHING         // Emparejar
  ORDERING         // Ordenar elementos
  DRAG_DROP        // Arrastrar y soltar
}

enum QuestionDifficulty {
  EASY
  MEDIUM
  HARD
}

enum AttemptStatus {
  IN_PROGRESS      // En progreso
  SUBMITTED        // Enviado
  COMPLETED        // Completado y calificado
  EXPIRED          // Expirado por tiempo
  CANCELLED        // Cancelado
}

enum AssignmentStatus {
  ASSIGNED         // Asignado
  STARTED          // Iniciado
  SUBMITTED        // Enviado
  COMPLETED        // Completado
  OVERDUE          // Vencido
  CANCELLED        // Cancelado
}

enum AudioPosition {
  BEFORE_QUESTION  // Antes del texto de la pregunta
  AFTER_QUESTION   // Después del texto de la pregunta
  BEFORE_OPTIONS   // Antes de las opciones (para opción múltiple)
  SECTION_TOP      // Al inicio de la sección (compartido)
}
